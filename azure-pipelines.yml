trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: zipdeploy-secrets
- name: azureWebAppName
  value: 'rymecdemo'
- name: jarName
  value: 'java_app_service-0.0.1-SNAPSHOT.jar'
- name: zipPath
  value: '$(Build.ArtifactStagingDirectory)/app.zip'

steps:
- task: Gradle@2
  displayName: 'ğŸ”¨ Build Spring Boot App'
  inputs:
    gradleWrapperFile: 'gradlew'
    tasks: 'clean build'
    options: '--no-daemon'

- task: CopyFiles@2
  displayName: 'ğŸ“¦ Copy JAR to Staging Directory'
  inputs:
    contents: '**/build/libs/$(jarName)'
    targetFolder: '$(Build.ArtifactStagingDirectory)'

- task: Bash@3
  displayName: 'ğŸ¯ Rename JAR to app.jar'
  inputs:
    targetType: 'inline'
    script: |
      echo "Renaming $(jarName) to app.jar"
      mv "$(Build.ArtifactStagingDirectory)/$(jarName)" "$(Build.ArtifactStagingDirectory)/app.jar"

- task: ArchiveFiles@2
  displayName: 'ğŸ“ Archive app.jar'
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/app.jar'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(zipPath)'
    replaceExistingArchive: true

- task: Bash@3
  displayName: 'ğŸŒ Deploy to Azure App Service using ZipDeploy'
  inputs:
    targetType: 'inline'
    script: |
      echo "ğŸš€ Deploying to https://$(azureWebAppName).scm.azurewebsites.net/api/zipdeploy"
      curl -X POST \
        -u "$(DEPLOY_USER):$(DEPLOY_PASSWORD)" \
        --data-binary "@$(zipPath)" \
        "https://$(azureWebAppName).scm.azurewebsites.net/api/zipdeploy"
